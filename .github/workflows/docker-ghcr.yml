name: Build & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR (push)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/lily-b-lee/security_dashboard:latest
            ghcr.io/lily-b-lee/security_dashboard:${{ github.sha }}

  deploy:
    needs: build
    runs-on: self-hosted
    env:
      IMAGE_TAG: ${{ github.sha }}
      APP_DIR: /home/posacuser/apps/security_dashboard
    steps:
      - name: Sanity check (docker/compose)
        run: |
          set -euxo pipefail
          whoami
          which docker || true
          docker --version
          docker compose version || docker-compose --version || true

      - name: Login GHCR (pull)
        run: |
          echo "${{ secrets.PROD_DOCKER_PAT }}" | docker login ghcr.io -u lily-b-lee --password-stdin

      - name: Check image exists (fail fast)
        run: |
          set -euxo pipefail
          docker pull ghcr.io/lily-b-lee/security_dashboard:${IMAGE_TAG} || {
            echo "❌ Image tag not found: ${IMAGE_TAG}"
            echo "  - 확인: build job이 언더스코어 명으로 push 했는지"
            exit 1
          }

      - name: Write .env & compose up
        run: |
          set -euxo pipefail
          cd "${APP_DIR}"
          # .env 채움 (DB 값도 함께)
          cat > .env <<'EOF'
          IMAGE_TAG=${IMAGE_TAG}
          MYSQL_DATABASE=polaris_security
          MYSQL_USER=polaris
          MYSQL_PASSWORD=secuone
          MYSQL_ROOT_PASSWORD=secuone
          EOF

          # compose 플러그인/옛 바이너리 둘 다 대응
          if docker compose version >/dev/null 2>&1; then
            docker compose pull
            docker compose up -d
          else
            docker-compose pull
            docker-compose up -d
          fi

          docker image prune -f

      - name: Show status
        run: |
          set -euxo pipefail
          cd "${APP_DIR}"
          if docker compose version >/dev/null 2>&1; then
            docker compose ps
            docker compose logs -n 80
          else
            docker-compose ps
            docker-compose logs -n 80
          fi
