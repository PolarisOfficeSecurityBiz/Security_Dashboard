<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin_layout}">
<head>
  <meta charset="UTF-8"/>
  <title>Í≥†Í∞ùÏÇ¨ Í¥ÄÎ¶¨</title>

  <!-- ÌéòÏù¥ÏßÄ Ï†ÑÏö© CSS -->
  <link rel="stylesheet" th:href="@{/css/customers.css}" href="/css/customers.css"/>

  <!-- ÏµúÏÜå Ïú†Ìã∏ (CSS ÎØ∏Ï†ÅÏö© ÎåÄÎπÑ) -->
  <style>
    .hidden{display:none!important}
    body.modal-open{overflow:hidden}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:1000}
    .modal:not(.hidden){display:grid}
    .modal-panel{background:#fff;border-radius:14px;max-width:92vw;width:560px;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #e5e7eb}
    .modal-body{padding:16px}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;padding:0 16px 16px}
  </style>

  <th:block layout:fragment="head-scripts"></th:block>
</head>
<body>
  <!-- ‚úÖ content ÌîÑÎûòÍ∑∏Î®ºÌä∏ ÎÇ¥Î∂Ä -->
  <div layout:fragment="content">
    <div class="page-customers">

      <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
      <header class="page-header">
        <div class="breadcrumbs">
          <a th:href="@{/admin}">Dashboards</a>
          <span>/</span>
          <strong>Customers</strong>
        </div>
        <div class="page-actions">
          <!-- Ïù∏ÎùºÏù∏ fallback: Ïô∏Î∂Ä JS ÏóÜÏñ¥ÎèÑ Ïó¥Î¶º -->
          <button id="btnOpenCreateModal"
                  type="button"
                  class="btn-primary"
                  data-open="createCustomerModal"
                  aria-haspopup="dialog"
                  aria-expanded="false"
                  onclick="(function(){var m=document.getElementById('createCustomerModal');if(!m)return;m.classList.remove('hidden');m.setAttribute('aria-hidden','false');document.body.classList.add('modal-open');(m.querySelector('#customerName')||m).focus();document.getElementById('btnOpenCreateModal')?.setAttribute('aria-expanded','true');})();">
            Í≥†Í∞ùÏÇ¨ Ï∂îÍ∞Ä
          </button>
        </div>
      </header>

      <!-- KPI Ïπ¥Îìú -->
      <section class="kpis">
        <article class="kpi-card">
          <div class="kpi-icon users"></div>
          <div>
            <div class="kpi-label">Total Customers</div>
            <div class="kpi-value"
                 th:text="${metrics != null and metrics.totalCustomers != null ? metrics.totalCustomers : 0}">0</div>
            <div class="kpi-trend up"><span>16%</span><small> this month</small></div>
          </div>
        </article>

        <article class="kpi-card">
          <div class="kpi-icon vguard"></div>
          <div>
            <div class="kpi-label">V-Guard</div>
            <div class="kpi-value"
                 th:text="${metrics != null and metrics.vguard != null ? metrics.vguard : 0}">0</div>
            <div class="kpi-trend down"><span>1%</span><small> this month</small></div>
          </div>
        </article>

        <article class="kpi-card">
          <div class="kpi-icon secuone"></div>
          <div>
            <div class="kpi-label">SecuOne</div>
            <div class="kpi-value"
                 th:text="${metrics != null and metrics.secuone != null ? metrics.secuone : 0}">0</div>
            <div class="kpi-trend neutral"><span>‚Äî</span><small> this month</small></div>
          </div>
        </article>
      </section>

      <!-- Í≥†Í∞ùÏÇ¨ Î™©Î°ù -->
      <section class="card">
        <div class="card-head">
          <div>
            <h2>All Customers</h2>
            <button class="link-btn" type="button">Active Members</button>
          </div>

          <div class="table-tools">
            <label class="search">
              <input id="searchInput" type="search" placeholder="Search"/>
              <svg aria-hidden="true" viewBox="0 0 24 24">
                <path d="M21 21l-4.3-4.3m1.3-5A7 7 0 1 1 7 4a7 7 0 0 1 11 7Z"/>
              </svg>
            </label>

            <div class="dropdown">
              <button id="sortBtn" class="btn-ghost" type="button" aria-haspopup="true" aria-expanded="false">
                Sort by : <strong id="sortLabel">Newest</strong>
              </button>
              <ul id="sortMenu" class="menu hidden" role="menu" aria-labelledby="sortBtn">
                <li data-sort="new" role="menuitem" tabindex="0">Newest</li>
                <li data-sort="name" role="menuitem" tabindex="0">Name (A‚ÜíZ)</li>
                <li data-sort="company" role="menuitem" tabindex="0">Company (A‚ÜíZ)</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="customers-table" id="customersTable">
            <thead>
            <tr>
              <th style="width:28%">Í≥†Í∞ùÏÇ¨ID</th>
              <th style="width:28%">Í≥†Í∞ùÏÇ¨Î™Ö</th>
              <th style="width:24%">Ïó∞Í≤∞ÏÇ¨</th>
              <th style="width:20%">ÏÉùÏÑ±Ïùº</th>
            </tr>
            </thead>
            <tbody>
              <tr class="row-link"
                  th:each="c : ${customers}"
                  th:data-href="@{|/admin/customers/${c.customerId}|}"
                  th:onclick="|location.href='@{/admin/customers/{id}(id=${c.customerId})}'|"
                  tabindex="0">
                <td th:text="${c.customerId}">CID</td>
                <td th:text="${c.customerName}">Ïù¥Î¶Ñ</td>

                <!-- ‚úÖ DTOÏùò connectedCompanyName ÏÇ¨Ïö© -->
                <td th:text="${c.connectedCompanyName != null ? c.connectedCompanyName : '‚Äî'}">Ïó∞Í≤∞ÏÇ¨</td>

                <td th:text="${c.createAt}">2025-01-01</td>
              </tr>

              <tr th:if="${#lists.isEmpty(customers)}" class="empty">
                <td colspan="4" class="empty">Îì±Î°ùÎêú Í≥†Í∞ùÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ÌéòÏù¥Ïßï (ÎçîÎØ∏ UI) -->
        <footer class="pagination">
          <span class="page-hint"
                th:text="${page != null ? 'Showing data ' + page.from + ' to ' + page.to + ' of ' + page.total + ' entries' : 'Showing data 0 to 0 of 0 entries'}">
            Showing data 0 to 0 of 0 entries
          </span>
          <nav class="pager" aria-label="pagination">
            <button class="icon-btn" data-page="prev" aria-label="Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ">‚Äπ</button>
            <button class="page is-current">1</button>
            <button class="page">2</button>
            <button class="page">3</button>
            <button class="page">4</button>
            <button class="page">‚Ä¶</button>
            <button class="page">40</button>
            <button class="icon-btn" data-page="next" aria-label="Îã§Ïùå ÌéòÏù¥ÏßÄ">‚Ä∫</button>
          </nav>
        </footer>
      </section>

      <!-- üîµ Î™®Îã¨: content ÌîÑÎûòÍ∑∏Î®ºÌä∏ ÎÇ¥Î∂ÄÏóê ÏúÑÏπò -->
      <div id="createCustomerModal" class="modal hidden" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="createCustomerTitle">
          <div class="modal-header">
            <h3 id="createCustomerTitle">Í≥†Í∞ùÏÇ¨ Ï∂îÍ∞Ä</h3>
            <button type="button"
                    id="btnCloseCreateModal"
                    class="icon-btn"
                    data-close="createCustomerModal"
                    aria-label="Îã´Í∏∞">‚úï</button>
          </div>

          <form th:action="@{/admin/customers}" method="post" class="modal-body">
            <input type="hidden" name="_csrf" th:value="${_csrf != null ? _csrf.token : ''}" th:if="${_csrf != null}"/>

            <div class="form-row">
              <label for="customerName">Í≥†Í∞ùÏÇ¨Î™Ö <span class="req">*</span></label>
              <input id="customerName" name="customerName" type="text" required placeholder="Ïòà) Ìè¥ÎùºÎ¶¨Ïä§ Ïò§ÌîºÏä§"/>
            </div>

            <div class="form-row">
              <label for="connectedCompany">Ïó∞Í≤∞ÏÇ¨(ÏÑ†ÌÉù)</label>
              <select id="connectedCompany" name="connectedCompany">
                <option value="">-- ÏÑ†ÌÉù ÏóÜÏùå --</option>
                <option th:each="cc : ${connectedCompanies}"
                        th:value="${cc.customerId}"
                        th:text="${cc.customerName}">Î¶¨ÏÖÄÎü¨A</option>
              </select>
            </div>

            <div class="modal-footer">
              <button type="button"
                      class="btn-ghost"
                      id="btnCancelCreate"
                      data-close="createCustomerModal">Ï∑®ÏÜå</button>
              <button type="submit" class="btn-primary">Ï†ÄÏû•</button>
            </div>
          </form>
        </div>
      </div>
      <!-- /Î™®Îã¨ -->

      <!-- Ïù∏ÎùºÏù∏ Ìè¥Î∞±: Ïô∏Î∂Ä JS ÏóÜÏñ¥ÎèÑ Îã´Ìûò/Î∞∞Í≤Ω/ESC ÎèôÏûë -->
      <script>
        (function(){
          const qs=(s,r=document)=>r.querySelector(s);
          function closeModalById(id){
            const m=document.getElementById(id); if(!m)return;
            m.classList.add('hidden'); m.setAttribute('aria-hidden','true');
            document.body.classList.remove('modal-open');
            const opener=qs('#btnOpenCreateModal'); opener?.setAttribute('aria-expanded','false'); opener?.focus();
          }
          document.addEventListener('click',function(e){
            const closeBtn=e.target.closest('[data-close]');
            if(closeBtn){ e.preventDefault(); return closeModalById(closeBtn.getAttribute('data-close')||'createCustomerModal'); }
            const modal=e.target.closest('.modal');
            if(modal && e.target===modal){ return closeModalById(modal.id); }
          },{capture:true});
          document.addEventListener('keydown',function(e){
            if(e.key==='Escape'){
              const open=document.querySelector('.modal:not(.hidden)');
              if(open) closeModalById(open.id);
            }
          },{capture:true});
        })();
      </script>

      <!-- Ïô∏Î∂Ä JS (Ï∫êÏãúÎ≤ÑÏä§ÌÑ∞: #dates ÏÇ¨Ïö© / T() Í∏àÏßÄ) -->
      <script th:src="@{/js/customers.js(v=${#dates.createNow().time})}" src="/js/customers.js"></script>
    </div><!-- /.page-customers -->
  </div><!-- /layout:fragment content -->
</body>
</html>
