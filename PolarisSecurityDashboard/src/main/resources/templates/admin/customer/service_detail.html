<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin_layout}">

<head>
  <meta charset="UTF-8"/>
  <title th:text="${service.serviceName} + ' - 서비스 상세'">서비스 상세</title>

  <th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/service_detail.css(v=${#dates.createNow().time})}"/>
    <script defer th:src="@{/js/service_detail.js(v=${#dates.createNow().time})}"></script>
  </th:block>
</head>

<body data-page="service-detail">
<div layout:fragment="content">
  <main class="service-detail" role="main">

    <!-- 브레드크럼: 화살표만 -->
    <div class="page-breadcrumbs">
      <a class="btn btn-ghost btn-pill icon-back"
         aria-label="뒤로가기"
         th:href="@{|/admin/customers/${customer.customerId}|}">←</a>
      <div class="crumbs">
        <span class="crumb">서비스 상세</span>
        <span class="sep">/</span>
        <strong class="current" th:text="${service.serviceName}">서비스명</strong>
      </div>
    </div>

    <!-- =========== 서비스 정보 =========== -->
    <!-- =========== 서비스 정보 =========== -->
<section class="card card-elev section">
  <div class="card-head">
    <h3>서비스 정보</h3>

		<div class="head-actions" id="svcToolbar">
		  <!-- 보기 모드에서 보임 -->
		  <button type="button" id="btnSvcEdit"   class="btn btn-ghost btn-sm">수정</button>
		
		  <form class="inline" id="deleteForm"
		        th:action="@{|/admin/customers/${customer.customerId}/services/${service.serviceId}/delete|}"
		        method="post">
		    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
		    <button id="btnSvcDelete" type="submit" class="btn btn-danger btn-sm"
		            onclick="return confirm('서비스를 삭제할까요?');">삭제</button>
		  </form>
		
		  <!-- 편집 모드에서만 보임 -->
		  <button type="submit" form="svcForm" id="btnSvcSave"   class="btn btn-primary btn-sm" hidden>저장</button>
		  <button type="button"               id="btnSvcCancel" class="btn btn-ghost   btn-sm" hidden>취소</button>
		</div>

  </div>

	  <div class="accordion-panel show">
	  <form id="svcForm" class="form-grid" data-mode="view"
	        th:action="@{|/admin/customers/${customer.customerId}/services/${service.serviceId}/update|}"
	        method="post" th:object="${service}">
	    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
	
	    <!-- 1) 서비스 ID -->
	    <label class="form-label">서비스 ID</label>
	    <input class="form-control" th:value="${service.serviceId}" disabled/>
	
	    <!-- 2) 서비스명 -->
	    <label class="form-label">서비스명 *</label>
	    <input class="form-control" name="serviceName" required data-editable
	           th:value="${service.serviceName}" disabled/>
	
	    <!-- 3) 도메인 -->
	    <label class="form-label">도메인</label>
	    <input class="form-control" name="domain" data-editable
	           th:value="${service.domain}" disabled/>
	
	    <!-- 4) 상품유형 -->
	    <label class="form-label">상품유형</label>
	    <select class="form-control" data-editable disabled th:field="*{productType}">
	      <option value="">-- 선택 --</option>
	      <option value="V-Guard SDK2.0 - 일반버전">V-Guard SDK2.0 - 일반버전</option>
	      <option value="V-Guard SDK2.0 - RB 포함버전">V-Guard SDK2.0 - RB 포함버전</option>
	      <option value="V-Guard SDK2.0 - iOS 포함버전">V-Guard SDK2.0 - iOS 포함버전</option>
	      <option value="V-Guard SDK3.0 - 일반버전">V-Guard SDK3.0 - 일반버전</option>
	      <option value="V-Guard SDK3.0 - RB 포함버전">V-Guard SDK3.0 - RB 포함버전</option>
	      <option value="V-Guard SDK3.0 - iOS 포함버전">V-Guard SDK3.0 - iOS 포함버전</option>
	      <option value="Polaris SecuOne Web To App">Polaris SecuOne Web To App</option>
	      <option value="Polaris SecuOne App To App">Polaris SecuOne App To App</option>
	    </select>
	
	    <!-- 5) 라이선스 키 (입력과 같은 박스, 우측 버튼) -->
	    <label class="form-label">라이선스 키</label>
	    <div class="form-control input-addon">
	      <span class="grow"
	            th:classappend="${service.licenseId == null} ? 'muted' : ''"
	            th:text="${service.licenseId != null ? service.licenseId : '미발급'}">미발급</span>
	      <button type="submit" id="btnLicense" class="btn btn-primary btn-sm"
	              form="licenseIssueForm">발급하기</button>
	    </div>
	
	    <!-- 6) CPI -->
	    <label class="form-label">CPI</label>
	    <input class="form-control" type="number" name="cpiValue" data-editable
	           th:value="${service.cpiValue}" min="0" step="1" disabled/>
	
	    <!-- 7) RS Rate -->
	    <label class="form-label">RS Rate</label>
	    <input class="form-control" type="number" name="rsRate" data-editable
	           th:value="${service.rsRate}" min="0" step="0.01" disabled/>
	  </form>
	
	  <!-- ▶ 라이선스 발급 별도 form (중첩 방지) -->
	  <form id="licenseIssueForm"
	        th:action="@{|/admin/customers/${customer.customerId}/services/${service.serviceId}/license|}"
	        method="post" hidden>
	    <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
	  </form>
	</div>

</section>


    <!-- =========== 담당자 =========== -->
    <section class="card card-elev section">
      <div class="card-head">
        <h3>담당자</h3>
        <div class="head-actions">
          <button type="button" id="btnOpenContact" class="btn btn-primary btn-sm">담당자 추가</button>
        </div>
      </div>

      <div class="section-body">
        <table class="table">
          <thead>
          <tr><th>이름</th><th>이메일</th><th>직책</th><th>메모</th><th>생성일</th><th>액션</th></tr>
          </thead>
          <tbody>
          <tr th:each="c : ${contacts}">
            <td th:text="${c.username}">홍길동</td>
            <td th:text="${c.email}">name@company.com</td>
            <td th:text="${c.role}">Manager</td>
            <td th:text="${c.memo}">-</td>
            <td th:text="${c.createAt}">2025-01-01</td>
            <td class="row-actions">
              <form th:action="@{|/admin/customers/${customer.customerId}/services/${service.serviceId}/contacts/${c.id}/delete|}"
                    method="post" class="inline">
                <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>
                <button class="btn btn-danger btn-sm" onclick="return confirm('삭제할까요?');">삭제</button>
              </form>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(contacts)}">
            <td colspan="6" class="empty">등록된 담당자가 없습니다.</td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- =========== 로그 (틀) =========== -->
    <section class="card card-elev section">
      <div class="card-head"><h3>로그</h3></div>
      <div class="section-body">
        <table class="table log-table">
          <thead><tr><th>시간</th><th>레벨</th><th>메시지</th></tr></thead>
          <tbody><tr><td colspan="3" class="empty">로그 데이터가 없습니다.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- ===== 담당자 추가 모달 ===== -->
    <div id="contactModal" class="modal" aria-hidden="true">
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
        <div class="modal-header">
          <h3 id="contactTitle">담당자 추가</h3>
          <button type="button" class="icon-btn" data-close="contactModal" aria-label="닫기">✕</button>
        </div>

        <form class="modal-body"
              th:action="@{|/admin/customers/${customer.customerId}/services/${service.serviceId}/contacts|}"
              method="post" autocomplete="off">
          <input type="hidden" name="_csrf" th:if="${_csrf != null}" th:value="${_csrf.token}"/>

          <div class="form-row"><label>이름 *</label><input class="form-control" name="username" required/></div>
          <div class="form-row"><label>이메일</label><input class="form-control" type="email" name="email" placeholder="name@company.com"/></div>
          <div class="form-row"><label>직책</label><input class="form-control" name="role"/></div>
          <div class="form-row"><label>메모</label><textarea class="form-control" name="memo" rows="3"></textarea></div>

          <div class="modal-actions">
            <button type="button" class="btn btn-ghost" data-close="contactModal">취소</button>
            <button type="submit" class="btn btn-primary">추가</button>
          </div>
        </form>
      </div>
    </div>

  </main>
</div>
</body>
</html>
